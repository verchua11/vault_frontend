<div class="page-wrapper" (mouseover)="triggerIn();">
  <span *ngIf="selectedProject" class="file-info-header project-name-inside">{{ selectedProject.project_name }}</span>
  <div class="main-content">
    <div class="file-explorer">
      <div *ngIf="!selectedProject" class="welcome-page">
        <!-- <h1 class="file-info-header welcome-text">Welcome to</h1> -->
        <img class="welcome-image" src="assets/logos/WelcomeLogo.png">

      </div>
      <!-- <div *ngIf="!selectedProject" class="methodology-links">
        <h1>PM Methodology</h1>
        <div class="flexbox">
          <div class="methodology c-links">
            <h2>INITIATION</h2>
            <img class="c-image" src="https://vault.jcvassociates.ph/assets/logos/INITIATION.jpg" width="120">
            <ul class="block m-link">
              <li><a (click)="downloadTemplate(project)">Project Charter / Business Case</a></li>
              <li><a click>Stakeholders Register</a></li>
              <li><a click>Technical Due Diligence</a></li>
              <li><a click>Responsibility Assignment Matrix</a></li>
              <li><a click>Owner's Project Requirements/Project Brief</a></li>
              <li><a click>Risk Register</a></li>
              <li><a click>High Level Budget & Schedule</a></li>
            </ul>
          </div>
          <div class="methodology c-links">
            <h2>PLAN</h2>
            <img class="c-image" src="https://vault.jcvassociates.ph/assets/logos/PLAN.jpg" width="120">
            <ul class="block m-link">
              <li><a click>Project Execution Plan</a></li>
              <li><a click>Project Quality Plan</a></li>
              <li><a click>EH&S Plan</a></li>
              <li><a click>Design Compliance Report</a></li>
              <li><a click>Value Engineering Report</a></li>
              <li><a click>Constructibility Assessment</a></li>
              <li><a click>Procurement Strategy</a></li>
              <li><a click>Tender Event Programme</a></li>
              <li><a click>Prequalification Exercise</a></li>
              <li><a click>Awarding of Contracts & Services</a></li>
              <li><a click>Authority Submissions & Approvals</a></li>
            </ul>
          </div>
          <div class="methodology c-links">
            <h2>EXECUTE</h2>
            <img class="c-image" src="https://vault.jcvassociates.ph/assets/logos/EXECUTE.jpg" width="120">
            <ul class="block m-link">
              <li><a click>Contracts Administration</a></li>
              <li><a click>Compliance with Plans & Specifications</a></li>
            </ul>
          </div>
          <div class="methodology c-links">
            <h2>MONITOR & CONTROL</h2>
            <img class="c-image" src="https://vault.jcvassociates.ph/assets/logos/MONITOR.jpg" width="120">
            <ul class="block m-link">
              <li><a click>Change Control</a></li>
              <li><a click>Cost & Programme Management</a></li>
              <li><a click>Construction Progress Reporting</a></li>
              <li><a click>QA/QC Reporting</a></li>
              <li><a click>EH&S Compliance Review</a></li>
              <li><a click>Procurement Tracking</a></li>
              <li><a click>Works Coordination</a></li>
              <li><a click>Payment Evaluation</a></li>
              <li><a click>Variation Orders Review</a></li>
            </ul>
          </div>
          <div class="methodology c-links">
            <h2>CLOSE</h2>
            <img class="c-image" src="https://vault.jcvassociates.ph/assets/logos/CLOSE.jpg" width="120">
            <ul class="block m-link">
              <li><a click>Testing & Commissioning</a></li>
              <li><a click>Defects Rectification</a></li>
              <li><a click>Final Accounts & Cost Report</a></li>
              <li><a click>Close-out Documents</a></li>
              <li><a click>Authorities Approvals and Clearances</a></li>
              <li><a click>Vendors Performance Evaluation</a></li>
              <li><a click>Service Level Agreements & Preventive Maintenance Schedules</a></li>
            </ul>
          </div>
        </div>
      </div> -->
      <div *ngIf="!selectedProject" class="methodology-links">
        <!-- <h1>PM Methodology</h1> -->
        <div class="flexbox">
          <div class="navi-link methodology c-links initiation" data-bs-toggle="collapse" href="#initiation-menu"
            role="button" aria-expanded="false" aria-controls="initiation-menu" (click)="showMethod('initiation')">
            <div class="tooltip-reminder">
              <div class="tooltips-custom">
                <h3>Hover to see templates</h3>
                <i nz-icon nzType="caret-down" nzTheme="outline" class="arrow-tooltip"></i>
              </div>
            </div>
            <div>
              <h2>INITIATION</h2>
              <img class="c-image initiation-img" src="https://vault.jcvassociates.ph/assets/logos/INITIATION.svg"
                width="100">
              <div class="subnavi">
                <ul class="m-link initiation-menu collapse" id="initiation-menu">
                  <li><a (click)="getMethodology('Project Charter | Business Case')">Project Charter / Business Case</a>
                  </li>
                  <li><a (click)="getMethodology('Stakeholders Register')">Stakeholders Register</a></li>
                  <li><a (click)="getMethodology('Technical Due Diligence')">Technical Due Diligence</a></li>
                  <li><a (click)="getMethodology('Responsibility Assignment Matrix')">Responsibility Assignment
                      Matrix</a>
                  </li>
                  <li><a (click)="getMethodology('Owners Project Requirements | Project Brief')">Owner's Project
                      Requirements/Project Brief</a></li>
                  <li><a (click)="getMethodology('Risk Register')">Risk Register</a></li>
                  <li><a (click)="getMethodology('High Level Budget & Schedule')">High Level Budget & Schedule</a></li>
                </ul>
              </div>
            </div>
            <i nz-icon nzType="caret-right" nzTheme="outline" class="arrow-divider"></i>
          </div>
          <div #navAccount class="navi-link methodology c-links plan" data-bs-toggle="collapse" href="#plan-menu"
            role="button" aria-expanded="false" aria-controls="plan-menu" (click)="showMethod('plan')"
            (mouseover)="triggerIn('plan')">
            <div>
              <h2>PLAN</h2>
              <!-- <div class="method-image-plan">
            </div> -->
              <img class="c-image plan-img" src="https://vault.jcvassociates.ph/assets/logos/PLAN.svg" width="100">
              <ul class="m-link plan-menu collapse" id="plan-menu">
                <li><a (click)="getMethodology('Project Execution Plan')">Project Execution Plan</a></li>
                <li><a (click)="getMethodology('Project Quality Plan')">Project Quality Plan</a></li>
                <li><a (click)="getMethodology('EH&S Plan')">EH&S Plan</a></li>
                <li><a (click)="getMethodology('Design Compliance Report')">Design Compliance Report</a></li>
                <li><a (click)="getMethodology('Value Engineering Report')">Value Engineering Report</a></li>
                <li><a (click)="getMethodology('Constructibility Assessment')">Constructibility Assessment</a></li>
                <li><a (click)="getMethodology('Procurement Strategy')">Procurement Strategy</a></li>
                <li><a (click)="getMethodology('Tender Event Programme')">Tender Event Programme</a></li>
                <li><a (click)="getMethodology('Prequalification Exercise')">Prequalification Exercise</a></li>
                <li><a (click)="getMethodology('Awarding of Contracts & Services')">Awarding of Contracts & Services</a>
                </li>
                <li><a (click)="getMethodology('Authority Submissions & Approvals')">Authority Submissions &
                    Approvals</a>
                </li>
              </ul>
            </div>
            <!-- <img class="arrow-divider" src="https://vault.jcvassociates.ph/assets/logos/arrow.png" width="25"> -->
            <i nz-icon nzType="caret-right" nzTheme="outline" class="arrow-divider"></i>
          </div>
          <div #navAccount class="navi-link methodology c-links execute" data-bs-toggle="collapse" href="#execute-menu"
            role="button" aria-expanded="false" aria-controls="execute-menu" (click)="showMethod('execute')"
            (mouseover)="triggerIn('execute')">
            <div>
              <h2>EXECUTE</h2>
              <img class="c-image execute-img" src="https://vault.jcvassociates.ph/assets/logos/EXECUTE.svg" width="100">
              <ul class="m-link execute-menu collapse" id="execute-menu">
                <li><a (click)="getMethodology('Contracts Administration')">Contracts Administration</a></li>
                <li><a (click)="getMethodology('Compliance with Plans & Specifications')">Compliance with Plans &
                    Specifications</a></li>
              </ul>
            </div>
            <!-- <img class="arrow-divider" src="https://vault.jcvassociates.ph/assets/logos/arrow.png" width="25"> -->
            <i nz-icon nzType="caret-right" nzTheme="outline" class="arrow-divider"></i>
          </div>
          <div #navAccount class="navi-link methodology c-links monitor" data-bs-toggle="collapse" href="#monitor-menu"
            role="button" aria-expanded="false" aria-controls="monitor-menu" (click)="showMethod('monitor')"
            (mouseover)="triggerIn('monitor')">
            <div>
              <h2 class="one-liner">MONITOR & CONTROL</h2>
              <img class="c-image monitor-img" src="https://vault.jcvassociates.ph/assets/logos/MONITOR.svg" width="100">
              <ul class="m-link monitor-menu collapse" id="monitor-menu">
                <li><a (click)="getMethodology('Change Control')">Change Control</a></li>
                <li><a (click)="getMethodology('Cost & Programme Management')">Cost & Programme Management</a></li>
                <li><a (click)="getMethodology('Construction Progress Reporting')">Construction Progress Reporting</a>
                </li>
                <li><a (click)="getMethodology('QA|QC Reporting')">QA/QC Reporting</a></li>
                <li><a (click)="getMethodology('EH&S Compliance Review')">EH&S Compliance Review</a></li>
                <li><a (click)="getMethodology('Procurement Tracking')">Procurement Tracking</a></li>
                <li><a (click)="getMethodology('Works Coordination')">Works Coordination</a></li>
                <li><a (click)="getMethodology('Payment Evaluation')">Payment Evaluation</a></li>
                <li><a (click)="getMethodology('Variation Orders Review')">Variation Orders Review</a></li>
              </ul>
            </div>
            <!-- <img class="arrow-divider" src="https://vault.jcvassociates.ph/assets/logos/arrow.png" width="25"> -->
            <i nz-icon nzType="caret-right" nzTheme="outline" class="arrow-divider"></i>
          </div>
          <div #navAccount class="navi-link methodology c-links close" data-bs-toggle="collapse" href="#close-menu"
            role="button" aria-expanded="false" aria-controls="close-menu" (click)="showMethod('close')"
            (mouseover)="triggerIn('close')">
            <div>
              <h2>CLOSE</h2>
              <img class="c-image close-img" src="https://vault.jcvassociates.ph/assets/logos/CLOSE.svg" width="100">
              <ul class="m-link close-menu collapse" id="close-menu">
                <li><a (click)="getMethodology('Testing & Commissioning')">Testing & Commissioning</a></li>
                <li><a (click)="getMethodology('Defects Rectification')">Defects Rectification</a></li>
                <li><a (click)="getMethodology('Final Accounts & Cost Report')">Final Accounts & Cost Report</a></li>
                <li><a (click)="getMethodology('Close-out Documents')">Close-out Documents</a></li>
                <li><a (click)="getMethodology('Authorities Approvals and Clearances')">Authorities Approvals and
                    Clearances</a></li>
                <li><a (click)="getMethodology('Vendors Performance Evaluation')">Vendors Performance Evaluation</a>
                </li>
                <li><a (click)="getMethodology('Service Level Agreements & Preventive Maintenance Schedules')">Service
                    Level Agreements & Preventive Maintenance Schedules</a></li>
              </ul>
            </div>
          </div>
        </div>

      </div>
      <nz-collapse nzAccordion *ngIf="selectedProject" class="mt-2">
        <nz-collapse-panel *ngFor="
            let stage of stages;
            let stageIdx = index
          " [nzHeader]="stage.name" 
          [nzActive]="stage.active"
          (nzActiveChange)="onCollapsePanelChange(stage)">
          <div class="folder-breadcrumb">
            <nz-breadcrumb>
              <nz-breadcrumb-item *ngFor="let breadcrumb of currBreadcrumbs; let i = index">
                <i *ngIf="i === 0" nz-icon nzType="home" nzTheme="outline" class="me-2"></i>
                <a (click)="navigateBreadcrumb(i)">{{ breadcrumb }}</a>
              </nz-breadcrumb-item>
            </nz-breadcrumb>
          </div>
          <p class="file-explorer-header">Folders</p>
          <div class="folders">
            <nz-card *ngIf="currDirectoryLevel > 3 && userInfo.role !== '4'" class="folder-card-add mb-2" (click)="openFolderUploadModal(stage)">
              <div *ngIf="isMobile" class="file-thumbnail" (click)="openDirectory(stage, folder)">
                <img class="mobile-icon" src="assets/icons/Icon_New Folder.svg">
              </div>
              <div class="folder-card-content">
                <img src="assets/icons/Icon_New Folder.svg" alt="" />
                <p>New Folder</p>
              </div>
            </nz-card>
            <nz-card class="folder-card mb-2" 
            *ngFor="
                let folder of getDirectoryFolders();
                let folderIdx = index
              " 
              [ngClass]="{
                'selected-node': selectedFile?.Key == folder.Key
              }" (dblclick)="onFolderDoubleClick(folder)" (click)="selectDirectory(folder)">
              <div class="file-menu-folder">
                <a nz-dropdown [nzDropdownMenu]="fileMenu1" nzPlacement="bottomRight"  *ngIf="currDirectoryLevel > 3"><i nz-icon nzType="more"></i></a>
                <nz-dropdown-menu #fileMenu1="nzDropdownMenu">
                  <ul nz-menu >
                    <!-- <li *ngIf="folder.finalStarred == 0" nz-menu-item (click)="addToStarred(folder, true)">Add to
                      Starred</li>
                    <li *ngIf="folder.finalStarred == 1" nz-menu-item (click)="removeFromStarred(folder, true)">Remove
                      from Starred</li> -->
                    <li *ngIf="currDirectoryLevel > 3 && allowDelete" (click)="openRenameModal(folder, stage)"
                      nz-menu-item>Rename</li>
                    <li *ngIf="currDirectoryLevel > 3 && !folder.deleted && allowDelete" nz-menu-item
                      (click)="deleteFile(folder, true)">Delete</li>
                  </ul>
                </nz-dropdown-menu>
              </div>
              <div *ngIf="isMobile" class="file-thumbnail" >
                <img class="mobile-icon" src="assets/icons/mobile/Icon_Folder.svg">
              </div>
              <div class="folder-card-content">
                <img *ngIf="isMobile" src="assets/icons/mobile/Icon_Folder.svg">
                <i *ngIf="folder.name.indexOf('.') === -1 && !isMobile" nz-icon nzType="folder" nzTheme="fill"></i>
                <p *ngIf="!folder.newName">
                  {{
                  (stageIdx +
                  1) +
                  "." +
                  (folderIdx + 1 | number: "2.0") +
                  " " +
                  folder.name
                  }}
                </p>
                <p *ngIf="folder.newName">
                  {{
                  (stageIdx +
                  1) +
                  "." +
                  (folderIdx + 1 | number: "2.0") +
                  " " +
                  folder.newName
                  }}
                </p>
              </div>
            </nz-card>
          </div>

          <p *ngIf="currDirectoryLevel > 3" class="file-explorer-header">
            Files
          </p>
          <div class="folders">
            <nz-card *ngIf="currDirectoryLevel > 3 && userInfo.role !== '4'" class="folder-card-add mb-2" (click)="openFileUploadModal(stage)">
              <div class="file-thumbnail">
                <img class="mobile-file-icon" src="assets/icons/Icon_New File.svg" alt="" />
              </div>
              <div class="folder-card-content">
                <img src="assets/icons/Icon_New File.svg" alt="" />
                <p>New File</p>
              </div>
            </nz-card>
            <nz-card class="folder-card mb-2" *ngFor="let file of getDirectoryFiles();" [ngClass]="{
                'selected-node': selectedFile?.Key == file.Key
              }" (click)="selectFile(file)">
              <div class="file-menu">
                <a nz-dropdown [nzDropdownMenu]="fileMenu" nzPlacement="bottomRight"><i nz-icon nzType="more"></i></a>
                <nz-dropdown-menu #fileMenu="nzDropdownMenu">
                  <ul nz-menu>
                    <li nz-menu-item (click)="downloadFile(file)">Download</li>
                    <li *ngIf="file.finalStarred == 0" nz-menu-item (click)="addToStarred(file, false)">Add to Starred
                    </li>
                    <li *ngIf="file.finalStarred == 1" nz-menu-item (click)="removeFromStarred(file, false)">Remove from
                      Starred</li>
                    <li nz-menu-item *ngIf="allowDelete" (click)="openRenameModal(file, stage)">Rename</li>
                    <li *ngIf="!file.deleted && allowDelete" nz-menu-item (click)="deleteFile(file, false)">Delete</li>
                    <li nz-menu-item (click)="copyLocation(file)">Copy location</li>
                  </ul>
                </nz-dropdown-menu>
              </div>
              <div class="file-thumbnail">
                <i *ngIf="isMobile" class="mobile-file-icon-svg" nz-icon [nzType]="getFileIcon(file.name)"
                  nzTheme="outline"></i>
                <i *ngIf="!isMobile" nz-icon [nzType]="getFileIcon(file.name)" nzTheme="fill"></i>
              </div>
              <div class="folder-card-content">
                <i *ngIf="file.type === TYPE_FILE && isMobile" nz-icon [nzType]="getFileIcon(file.name)"
                  nzTheme="outline"></i>
                <i *ngIf="file.type === TYPE_FILE && !isMobile" nz-icon [nzType]="getFileIcon(file.name)"
                  nzTheme="fill"></i>

                <p nz-tooltip nzTooltipTitle="{{ file.name }}" nzTooltipColor="white" *ngIf="!file.newName">
                  {{ file.name }}
                </p>
                <p nz-tooltip nzTooltipTitle="{{ file.name }}" nzTooltipColor="white" *ngIf="file.newName">
                  {{ file.newName }}
                </p>
              </div>
            </nz-card>
          </div>
        </nz-collapse-panel>
      </nz-collapse>
    </div>
    <div id="clipboard-toast">Copied to clipboard</div>

    <div class="file-info">
      <p class="file-info-header">My Vault</p>
      <p class="file-info-subtext">
        Select a file or folder to view its details
      </p>
      <div>
        <div *ngIf="selectedFile">
          <div class="folder-icon">
            <i class="mt-2 mb-2" nz-icon [nzType]="
                selectedFile.type.toLowerCase()
              " nzTheme="outline"></i>
          </div>
          <div class="file-metadata">
            <p>
              File Name: {{selectedFile.name}}
            </p>
            <p>
              Type:
              {{ selectedFile.type}}
            </p>
            <p *ngIf="selectedFile.type === 'File'">
              Size: {{ (selectedFile.Size / 1000000).toFixed(2) }} MB 
              ({{ selectedFile.Size }} bytes)
            </p>
            <p *ngIf="selectedFile.type === 'File'">
              Storage used: {{ (selectedFile.Size / 1000000).toFixed(2) }} MB
              ({{ selectedFile.Size }}
              bytes)
            </p>
            <p>Location: My Vault</p>
            <p>Owner: {{ selectedFile.Owner.DisplayName }}</p>
            <p>Modified: {{ getFormattedDate(selectedFile.LastModified) }}</p>
            <!-- <p>Opened: Dec 25, 2020 by me</p>
            <p>Created: Dec 23, 2020</p> -->
          </div>
        </div>
        <div *ngIf="!selectedFile">
          <nz-empty nzNotFoundContent="No selected file/folder." style="margin-top: 2rem" class="no-selected">
          </nz-empty>
        </div>
      </div>
    </div>
  </div>

</div>

<div [ngClass]="
    isLoadingVault ? 'preloader-overlay-show' : 'preloader-overlay-hide'
  " class="preloader-overlay">
  <nz-spin nzSimple [nzSize]="'large'" nzTip="Loading Vault..."></nz-spin>
</div>

<div [ngClass]="
    isDownloading ? 'preloader-overlay-show' : 'preloader-overlay-hide'
  " class="preloader-overlay">
  <nz-spin nzSimple [nzSize]="'large'" nzTip="Retrieving file..."></nz-spin>
</div>

<div [ngClass]="
    isGettingTemplate ? 'preloader-overlay-show' : 'preloader-overlay-hide'
  " class="preloader-overlay">
  <nz-spin nzSimple [nzSize]="'large'" nzTip="Getting templates..."></nz-spin>
</div>

<div [ngClass]="isDeleting ? 'preloader-overlay-show' : 'preloader-overlay-hide'" class="preloader-overlay">
  <nz-spin nzSimple [nzSize]="'large'" nzTip="Deleting file..."></nz-spin>
</div>

<nz-modal [(nzVisible)]="isVisible" nzMaskClosable="false" nzTitle="{{
    uploadForm.get('uploadType').value === '2' ? 'New Folder' :  uploadForm.get('uploadType').value === '1' ? 'New File' : uploadForm.get('methodology').value
}}" (nzOnCancel)="closeUploadModal()">
  <form [formGroup]="uploadForm" (ngSubmit)="submitUpload()">
    <ng-container *nzModalContent>
      <div *ngIf="uploadForm.get('uploadType').value === '1'">
        <nz-upload [(nzFileList)]="fileList" nzMultiple="true" [nzBeforeUpload]="beforeUpload">
          <button nz-button><i nz-icon nzType="upload"></i>Select File</button>
        </nz-upload>
      </div>
      <div *ngIf="uploadForm.get('uploadType').value === '2'">
        <nz-input-group nzAddOnBefore="Folder name:">
          <input type="text" nz-input formControlName="folderName" />
        </nz-input-group>
      </div>
      <div *ngIf="uploadForm.get('uploadType').value === '3'">
        <nz-upload [(nzFileList)]="fileList" nzMultiple="true" *ngIf="userInfo.role !== '4'" [nzBeforeUpload]="beforeUpload">
          <button nz-button><i nz-icon nzType="upload"></i>Add Template</button>
        </nz-upload>
        <nz-input-group nzAddOnBefore="" class="template-container">
          <div *ngFor="let result of uploadForm.get('results').value;
          ">
            <!-- <div class="file-thumbnail">
              <i ngIf="isMobile" class="mobile-file-icon-svg" nz-icon [nzType]="getFileIcon(result)"
                nzTheme="outline"></i>
              <i ngIf="!isMobile" nz-icon [nzType]="getFileIcon(result)" nzTheme="fill"></i>
            </div> -->
            <div *ngIf="result.split('/')[2]" class="templates">
              <i nz-icon nzType="file" nzTheme="outline"></i>
              <a class="template-links" (click)="downloadTemplate(result, result.split('/')[2])"> {{
                result.split("/")[2]
                }} </a>
            </div>
          </div>

        </nz-input-group>
      </div>
    </ng-container>
    <div *nzModalFooter class="d-flex justify-content-end">
      <button [disabled]="isSubmitting" nz-button nzType="default" (click)="closeUploadModal()">
        Cancel
      </button>
      <button type="submit" nz-button nzType="primary" [nzLoading]="isSubmitting" (click)="submitUpload()">
        Submit
      </button>
    </div>
  </form>
</nz-modal>

<!-- renameForm -->
<nz-modal [(nzVisible)]="renameModalVisible" nzMaskClosable="false" nzTitle="Rename" (nzOnCancel)="closeUploadModal()">
  <form [formGroup]="renameForm" (ngSubmit)="renameSubmit()">
    <ng-container *nzModalContent>
      <p>Enter new name for <strong>{{currItemName}}</strong>:</p>
      <input type="text" nz-input formControlName="newName" />
    </ng-container>
    <div *nzModalFooter class="d-flex justify-content-end">
      <button [disabled]="isSubmitting" nz-button nzType="default" (click)="closeUploadModal()">
        Cancel
      </button>
      <button type="submit" nz-button nzType="primary" [nzLoading]="isSubmitting" (click)="renameSubmit()">
        Submit
      </button>
    </div>
  </form>
</nz-modal>